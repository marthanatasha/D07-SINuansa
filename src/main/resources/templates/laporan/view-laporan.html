<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Financial Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>
<body>
    <div class="flex">
        <button th:replace="fragments/sidebar :: sidebarhead"></button>
        <aside th:replace="fragments/sidebar :: sidebar('Report')"></aside>
        <div class="sm:ml-64 bg-slate-200 min-h-screen w-full">
            <div class="p-10">
                <h1 class="text-3xl">Financial Report</h1>
            </div>
            <div>
                <div>
                    <select id="month">
                        <option value="" disabled selected>Select month</option>
                        <option th:each="months, iterationStatus: ${monthList}" th:text="${months}" th:value="${iterationStatus.count}"></option>
                    </select>
                </div>
                <div>
                    <select id="year">
                        <option value="" disabled selected>Select year</option>
                        <option th:each="years, iterationStatus2: ${yearList}" th:text="${years}"></option>
                    </select>
                </div>
                <button onclick="getValue()">
                    Cari
                </button>
            </div>
            <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" data-tabs-toggle="#myTabContent" role="tablist">
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="profile-tab" data-tabs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false" onclick="getPDF()">PDF</button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="dashboard-tab" data-tabs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false" onclick="getLine()">Line Chart</button>
                    </li>
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="settings-tab" data-tabs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false" onclick="getBar()">Bar Chart</button>
                    </li>
                </ul>
            </div>
            <div class="flex justify-center pt-7">
                <div id="myTabContent" class="block p-6 bg-white border rounded-lg shadow w-2/4 pt-15">
                    <canvas id="lineChart" width="240px" height="120px"></canvas>

                    <!-- <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="pdf" role="tabpanel" aria-labelledby="profile-tab">
                        <p class="text-sm text-gray-500 dark:text-gray-400">This is some placeholder content the <strong class="font-medium text-gray-800 dark:text-white">Profile tab's associated content</strong>. Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling.</p>
                    </div>
                    <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="line" role="tabpanel" aria-labelledby="dashboard-tab">
                        <p class="text-sm text-gray-500 dark:text-gray-400">This is some placeholder content the <strong class="font-medium text-gray-800 dark:text-white">Dashboard tab's associated content</strong>. Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling.</p>
                    </div>
                    <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="bar" role="tabpanel" aria-labelledby="settings-tab">
                        <p class="text-sm text-gray-500 dark:text-gray-400">This is some placeholder content the <strong class="font-medium text-gray-800 dark:text-white">Settings tab's associated content</strong>. Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling.</p>
                    </div> -->
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        function getValue(){
            var yearSelect = document.getElementById("year").value;
            var monthSelect = document.getElementById("month").value;
            var today = new Date();
            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "Decemmber"];
            console.log("fungsi");
            if(today.getFullYear()==yearSelect){
                console.log(today.getMonth());
                console.log(monthSelect);
                if(today.getMonth()+1<=monthSelect){
                    console.log("if 2");
                    alert(`Maksimal bulan yang dipilih untuk tahun ${yearSelect} adalah ${months[today.getMonth()]}`)
                }
                else{
                    var url = window.location.href;
                    console.log(url);
                    var urlFixed = url.slice(0, 28);
                    console.log(urlFixed);
                    window.location.href = urlFixed + "/" + monthSelect + "/" + yearSelect;
                }
            }
        }


        function getPDF(){
            var dataPDF = [[${laporanDTO}]]
            var laporanItemPP ="";
            var laporanItemHPP="";
            var laporanItemBO ="";
            var laporanItemBL = "";
            for(let i =0; i<3; i++){
                laporanItemPP += `<tr> <td> <p>${dataPDF.listTransaksi[i].ref}</p> </td>
                        <td>${dataPDF.listTransaksi[i].total}</td> </tr>`
            }
            for(let i =3; i<5; i++){
                laporanItemHPP += `<tr> <td> <p>${dataPDF.listTransaksi[i].ref}</p> </td>
                        <td>${dataPDF.listTransaksi[i].total}</td> </tr>`
            }
            for(let i =5; i<12; i++){
                laporanItemBO += `<tr> <td> <p>${dataPDF.listTransaksi[i].ref}</p> </td>
                        <td>${dataPDF.listTransaksi[i].total}</td> </tr>`
            }
            for(let i =12; i<15; i++){
                laporanItemBL += `<tr> <td> <p>${dataPDF.listTransaksi[i].ref}</p> </td>
                        <td>${dataPDF.listTransaksi[i].total}</td> </tr>`
            }
            var content = document.getElementById("myTabContent");
            console.log(dataPDF.cabang);
            content.innerHTML = "";
            content.innerHTML += `
                <div id="pdf">
                <div>
                    <p class="text-xl font-semibold text-center">${dataPDF.cabang}</p>
                    <p class="text-xl font-semibold text-center">Laba Rugi</p>
                    <p class="text-center">${dataPDF.bulan}  -  ${dataPDF.tahun}</p>
                    <p class="text-center">(dalam IDR)</p>
                    <hr>
                    <table style="width:100%">
                        <tr>
                            <td> <p class="font-bold">Pendapatan</p> </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Pendapatan dari Penjualan</p> </td>
                            <td></td>
                        </tr>
                        ${laporanItemPP}
                        <hr>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Total Pendapatan dari Penjualan</p> </td>
                            <td>${dataPDF.totalPendapatanPenjualan}</td>
                        </tr>
                        <br>
                        <tr>
                            <td> <p class="font-semibold">Harga Pokok Penjualan</p> </td>
                            <td></td>
                        </tr>
                        ${laporanItemHPP}
                        <tr>
                            <td> <p class="font-semibold">Total Harga Pokok Penjualan</p> </td>
                            <td>${dataPDF.totalHargaPokokPenjualan}</td>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Laba Kotor</p> </td>
                            <td>${dataPDF.labaKotor}</td>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Biaya Operasional</p> </td>
                            <td></td>
                        </tr>
                        ${laporanItemBO}
                        <tr>
                            <td> <p class="font-semibold">Total Biaya</p> </td>
                            <td>${dataPDF.totalBiaya}</td>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Pendapatan Bersih Operasional</p> </td>
                            <td>${dataPDF.pendapatanBersihOperasional}</td>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Biaya Lainnya</p> </td>
                            <td></td>
                        </tr>
                        ${laporanItemBL}
                        <tr>
                            <td> <p class="font-semibold">Total Biaya Lainnya</p> </td>
                            <td>${dataPDF.totalBiayaLainnya}</td>
                        </tr>
                        <tr>
                            <td> <p class="font-semibold">Pendapatan Bersih</p> </td>
                            <td>${dataPDF.pendapatanBersih}</td>
                        </tr>
                    </div>
                    <button class="rounded-full bg-cyan-900 text-slate-100 px-5 py-2 text-lg mr-3" onclick="download()">Print</button>
            </div>`
        }

        function getLine(){
            var content = document.getElementById("myTabContent");
            content.innerHTML = `<canvas id="lineChart" width="240px" height="120px"></canvas>`;
            const lineChart = document.getElementById("lineChart");
            var dataLine = [[${lineChart}]]
            new Chart(lineChart, {
                type: 'line',
                data: {
                    labels: dataLine.labels,
                    datasets: [{
                        label: "Pendapatan Bersih per Hari",
                        borderColor: "rgb(75, 192, 192)",
                        data: dataLine.data,
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function getBar(){
            var content = document.getElementById("myTabContent");
            content.innerHTML = `<canvas id="lineChart" width="240px" height="120px"></canvas>`;
            const barChart = document.getElementById("lineChart");
            var dataBar = [[${barChart}]]
            new Chart(barChart, {
                type: 'bar',
                data: {
                    labels: dataBar.labels,
                    datasets: [{
                        label: "Jumlah Pembelian Bahan Baku Kopi",
                        borderColor: "rgb(75, 192, 192)",
                        backgroundColor: "rgb(75, 192, 192)",
                        borderWidth: 1,
                        data: dataBar.data,
                    },{
                        label: "Jumlah Pemesanan Bahan Baku Kopi",
                        borderColor: "rgb(255, 153, 255)",
                        backgroundColor: "rgb(255, 153, 255)",
                        borderWidth: 1,
                        data: dataBar.data2,
                    }
                    ]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }

        var data = [[${laporanDTO}]]

        function download() {

            var pdf = new jsPDF('p', 'mm', 'a4');
            var width = pdf.internal.pageSize.width;
            var height = pdf.internal.pageSize.height;
            pdf.setFont('Helvetica');
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'bold');
            pdf.text(data.cabang, 80, 20, {align:'center'})
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('Laba Rugi', 94, 25, {align:'center'});
            pdf.text(data.bulan + " " + data.tahun, 92, 30, {align:'center'});
            pdf.setLineWidth(1);
            pdf.line(width/8, 35, width*7/8, 35);
            pdf.setFont(undefined, 'bold');
            pdf.text('Pendapatan', width/8, 40);
            pdf.setFont(undefined, 'normal');
            pdf.text('Pendapatan dari Penjualan', width/8, 45);
            let pp = 3;
            let hpp = 2;
            let bo = 7;
            let bl = 3;
            for(let i =0; i<pp; i++){
                pdf.text(data.listTransaksi[i].ref, width/8+5, 50+i*5);
                pdf.text(""+data.listTransaksi[i].total, 170, 50+i*5);
                pdf.setLineWidth(0.1);
                pdf.line(width/8, 50+i*5+1.5, width*7/8, 50+i*5+1.5);
            }
            pdf.setFont(undefined, 'bold');
            pdf.text('Total Pendapatan dari Penjualan', width/8, 50+pp*5);
            pdf.text(""+data.totalPendapatanPenjualan, 170, 50+pp*5);
            pdf.setFont(undefined, 'normal');
            pdf.text('Harga Pokok Penjualan', width/8, 60+pp*5);
             for(let i =3; i<hpp+pp; i++){
                pdf.text(data.listTransaksi[i].ref, width/8+5, 65+pp*5+(i-3)*5);
                pdf.text(""+data.listTransaksi[i].total, 170, 65+pp*5+(i-3)*5);
                pdf.setLineWidth(0.1);
                pdf.line(width/8, 65+pp*5+(i-3)*5+1.5, width*7/8, 65+pp*5+(i-3)*5+1.5);
            }
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(255,0,0);
            pdf.text('Total Harga Pokok Penjualan', width/8, 65+pp*5+hpp*5);
            pdf.setTextColor(0,0,0);
            pdf.text(""+data.totalHargaPokokPenjualan, 170, 65+pp*5+hpp*5);
            pdf.setLineWidth(0.1);
            pdf.line(width/8, 65+pp*5+hpp*5+1.5, width*7/8, 65+pp*5+hpp*5+1.5);
            pdf.text('Laba Kotor', width/8, 70+pp*5+hpp*5);
            pdf.text(""+data.labaKotor, 170, 70+pp*5+hpp*5);
            pdf.setFont(undefined, 'normal');
            pdf.text('Biaya Operasional', width/8, 80+pp*5+hpp*5);
            for(let i =5; i<hpp+pp+bo; i++){
                pdf.text(data.listTransaksi[i].ref, width/8+5, 85+pp*5+hpp*5+(i-5)*5);
                pdf.text(""+data.listTransaksi[i].total, 170, 85+pp*5+hpp*5+(i-5)*5);
                pdf.setLineWidth(0.1);
                pdf.line(width/8, 85+pp*5+(i-3)*5+1.5, width*7/8, 85+pp*5+hpp*5+(i-5)*5+1.5);
            }
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(255,0,0);
            pdf.text('Total Biaya', width/8, 85+pp*5+hpp*5+bo*5);
            pdf.setTextColor(0,0,0);
            pdf.text(""+data.totalBiaya, 170, 85+pp*5+hpp*5+bo*5);
            pdf.setLineWidth(0.1);
            pdf.line(width/8, 85+pp*5+hpp*5+bo*5+1.5, width*7/8, 85+pp*5+hpp*5+bo*5+1.5);
            pdf.text('Pendapatan Bersih Operasional', width/8, 90+pp*5+hpp*5+bo*5);
            pdf.text(""+data.pendapatanBersihOperasional, 170, 90+pp*5+hpp*5+bo*5);
            pdf.setFont(undefined, 'normal');
            pdf.text('Biaya Lainnya', width/8, 100+pp*5+hpp*5+bo*5);
            for(let i =12; i<hpp+pp+bo+bl; i++){
                pdf.text(data.listTransaksi[i].ref, width/8+5, 105+pp*5+hpp*5+bo*5+(i-12)*5);
                pdf.text(""+data.listTransaksi[i].total, 170, 105+pp*5+hpp*5+bo*5+(i-12)*5);
                pdf.setLineWidth(0.1);
                pdf.line(width/8, 105+pp*5+hpp*5+bo*5+(i-12)*5+1.5, width*7/8, 105+pp*5+hpp*5+bo*5+(i-12)*5+1.5);
            }
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(255,0,0);
            pdf.text('Total Biaya Lainnya', width/8, 105+pp*5+hpp*5+bo*5+bl*5);
            pdf.setTextColor(0,0,0);
            pdf.text(""+data.totalBiayaLainnya, 170, 105+pp*5+hpp*5+bo*5+bl*5);
            pdf.setLineWidth(0.1);
            pdf.line(width/8,105+pp*5+hpp*5+bo*5+bl*5+1.5, width*7/8, 105+pp*5+hpp*5+bo*5+bl*5+1.5);
            pdf.text('Pendapatan Bersih', width/8, 110+pp*5+hpp*5+bo*5+bl*5);
            pdf.text(""+data.pendapatanBersihOperasional, 170, 110+pp*5+hpp*5+bo*5+bl*5);
            pdf.save(`Laporan keuangan ${data.cabang} ${data.bulan} ${data.tahun}`);
    }
    </script>
</body>
</html>